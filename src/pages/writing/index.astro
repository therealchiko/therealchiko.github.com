---
import Base from '../../layouts/Base.astro';
import PostList from '../../components/PostList.astro';
import { getCollection } from 'astro:content';
import { sortPostsByDate, getPostDate } from '../../utils/posts';

const allPosts = await getCollection('writing', ({ data }) => !data.draft);
const sortedPosts = sortPostsByDate(allPosts).map(post => ({
  ...post,
  data: { ...post.data, date: getPostDate(post) }
}));

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = post.data.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
---

<Base title="Writing">
  <section class="mb-12">
    <h1 class="text-3xl font-semibold mb-4">Writing</h1>
    <p class="text-[var(--color-muted)]">
      Essays on software engineering, startups, and life. {sortedPosts.length} posts and counting.
    </p>
  </section>

  {years.map((year) => (
    <section class="mb-12">
      <h2 class="text-lg font-medium text-[var(--color-muted)] mb-4">{year}</h2>
      <PostList posts={postsByYear[year]} />
    </section>
  ))}

  {sortedPosts.length === 0 && (
    <p class="text-[var(--color-muted)]">No posts yet. Check back soon.</p>
  )}
</Base>
